<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Trocas | Dunamis Bombeiros</title>
    <style>
        /* VISUAL ESTRITAMENTE ID√äNTICO √Ä V1 */
        :root { 
            --dunamis-red: #d32f2f; 
            --dunamis-blue: #1a237e;
            --success: #2e7d32; 
            --warning: #f57f17;
            --error: #b71c1c;
            --whatsapp: #25d366;
            --bg: #f4f7f6; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); display: flex; justify-content: center; 
            align-items: center; min-height: 100vh; margin: 0; padding: 10px;
        }

        .container { 
            width: 100%; max-width: 550px; background: white; padding: 25px; 
            border-radius: 15px; box-shadow: 0 12px 30px rgba(0,0,0,0.1); 
            border-top: 10px solid var(--dunamis-red);
        }
        
        header { text-align: center; margin-bottom: 20px; }
        .logo-img { max-width: 180px; height: auto; margin-bottom: 5px; }

        .progress-bar { 
            display: flex; justify-content: space-between; margin-bottom: 30px; 
            border-bottom: 2px solid #eee; padding-bottom: 12px;
        }
        .progress-bar span { font-size: 10px; color: #aaa; font-weight: bold; text-transform: uppercase; flex: 1; text-align: center; }
        .progress-bar .active { color: var(--dunamis-red); border-bottom: 3px solid var(--dunamis-red); margin-bottom: -15px; }

        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--dunamis-blue); font-size: 12px; text-transform: uppercase; }
        
        input, textarea, select { 
            width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; background: #fafafa; font-family: inherit;
        }

        .dual-date-container { display: flex; gap: 10px; align-items: stretch; }
        .manual-date { flex: 3; text-align: center; letter-spacing: 1px; }
        
        .picker-wrapper { 
            flex: 1; position: relative; background: #fff; border: 2px solid #333; 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; overflow: hidden; 
        }
        
        .picker-input { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; z-index: 10; 
        }
        .calendar-icon-btn { font-size: 22px; z-index: 1; pointer-events: none; }

        textarea { resize: vertical; min-height: 80px; }
        input:focus, textarea:focus, select:focus { border-color: var(--dunamis-blue); outline: none; background: #fff; }
        
        .nome-encontrado { color: var(--success) !important; font-weight: bold; background-color: #f1f8e9 !important; border: 2px solid var(--success) !important; }
        .status-afastado { color: var(--error) !important; font-weight: bold; background-color: #ffebee !important; border: 2px solid var(--error) !important; }
        
        .btn-group { display: flex; gap: 12px; margin-top: 25px; }
        button { flex: 1; padding: 18px; border: none; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-next { background: var(--dunamis-red); color: white; }
        .btn-prev { background: #cfd8dc; color: #455a64; }
        .btn-finish { background: var(--dunamis-blue); color: white; }
        
        .btn-whatsapp { 
            background: var(--whatsapp); color: white; width: 100%; margin-top: 15px; 
            display: none; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-whatsapp:hover { background: #1ebc57; }

        .msg-sucesso-container {
            text-align: center; margin-top: 20px; display: none; 
            background-color: #e8f5e9; border: 1px solid #c8e6c9; 
            padding: 15px; border-radius: 10px;
        }
        .msg-sucesso-titulo { color: var(--success); font-weight: bold; font-size: 18px; display: block; margin-bottom: 5px; }
        .msg-sucesso-texto { color: #2e7d32; font-size: 14px; }

        .alerta-erro { background: #ffebee; border-left: 5px solid var(--dunamis-red); color: #b71c1c; padding: 12px; margin-top: 10px; font-size: 12px; border-radius: 5px; display: none; }
        .alerta-aviso { background: #fff3e0; border-left: 5px solid var(--warning); color: #e65100; padding: 12px; margin-top: 10px; font-size: 12px; border-radius: 5px; display: none; }
        
        .resumo-box { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 12px; padding: 25px; line-height: 1.8; font-size: 14px; }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 1000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--dunamis-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="loader"></div>
    <div style="color: #666; font-weight: bold;">Carregando Base...</div>
</div>

<div class="container">
    <div style="margin-bottom: 15px;">
        <button type="button" class="btn-prev" style="width: auto; padding: 8px 15px; font-size: 12px;" onclick="window.location.href='./gateway.html'">‚¨Ö Voltar para sele√ß√£o de empresa</button>
    </div>
    <header>
        <img src="./logo_dunamis.png" alt="Grupo Dunamis" class="logo-img">
    </header>
    <div id="grupo-selecionado-texto" style="text-align: center; font-weight: bold; color: var(--dunamis-blue); margin-top: -15px; margin-bottom: 20px; font-size: 14px;"></div>

    <div class="progress-bar">
        <span id="p1" class="active">Solicitante</span>
        <span id="p2">Substituto</span>
        <span id="p3">Concluir</span>
    </div>

    <div id="step1" class="step active">
        <div class="form-group">
            <label>Seu RE (Matr√≠cula)</label>
            <input type="number" id="re_sol" placeholder="Ex: 0000" oninput="buscar('sol')">
            <div id="e_status_sol" class="alerta-erro"></div>
        </div>
        <div class="form-group">
            <label>Seu Nome</label>
            <input type="text" id="nome_sol" readonly placeholder="Aguardando RE...">
        </div>
        
        <div class="form-group">
            <label>Unidade da Troca</label>
            <select id="unidade_troca">
                <option value="">Selecione a unidade...</option>
            </select>
        </div>

        <div class="form-group">
            <label>DATA QUE IREI TRABALHAR</label>
            <div class="dual-date-container">
                <input type="tel" id="data_folga_txt" class="manual-date" placeholder="DD/MM/AAAA" maxlength="10" oninput="syncManual('data_folga')">
                <div class="picker-wrapper" onclick="abrirCalendario('data_folga')">
                    <span class="calendar-icon-btn">üìÖ</span>
                    <input type="date" id="data_folga" class="picker-input" oninput="syncPicker('data_folga')" onchange="syncPicker('data_folga')">
                </div>
            </div>
            <div id="e_folha_fechada_folga" class="alerta-erro"></div>
            <div id="e_turma_folga" class="alerta-erro"></div>
        </div>
        <div class="btn-group">
            <button type="button" class="btn-prev" onclick="window.location.href='./gateway.html'">Voltar</button>
            <button type="button" class="btn-next" onclick="nextStep(2)">Pr√≥ximo Passo</button>
        </div>
    </div>

    <div id="step2" class="step">
        <div class="form-group">
            <label>RE do Substituto</label>
            <input type="number" id="re_sub" placeholder="Ex: 0000" oninput="buscar('sub')">
            <div id="e_re" class="alerta-erro"></div>
            <div id="e_status_sub" class="alerta-erro"></div>
        </div>
        <div class="form-group">
            <label>Nome do Substituto</label>
            <input type="text" id="nome_sub" readonly placeholder="Aguardando RE...">
        </div>
        
        <div class="form-group">
            <label>DATA DE PAGAMENTO DA TROCA (DIA QUE IREI FOLGAR)</label>
            <div class="dual-date-container">
                <input type="tel" id="data_pagamento_txt" class="manual-date" placeholder="DD/MM/AAAA" maxlength="10" oninput="syncManual('data_pagamento')">
                <div class="picker-wrapper" onclick="abrirCalendario('data_pagamento')">
                    <span class="calendar-icon-btn">üìÖ</span>
                    <input type="date" id="data_pagamento" class="picker-input" oninput="syncPicker('data_pagamento')" onchange="syncPicker('data_pagamento')">
                </div>
            </div>
            <div id="e_folha_fechada_pagamento" class="alerta-erro"></div>
            <div id="e_turma_pagamento" class="alerta-erro"></div>
            <div id="e_escala" class="alerta-erro"></div> 
            <div id="e_folha" class="alerta-aviso"></div>  
        </div>
        
        <div class="form-group">
            <label>Motivo da Troca</label>
            <textarea id="motivo_troca" placeholder="Descreva brevemente o motivo da solicita√ß√£o..."></textarea>
        </div>
        
        <div class="btn-group">
            <button type="button" class="btn-prev" onclick="nextStep(1)">Voltar</button>
            <button type="button" class="btn-next" onclick="nextStep(3)">Revisar</button>
        </div>
    </div>

    <div id="step3" class="step">
        <div class="resumo-box" id="resumo_txt"></div>
        
        <div class="btn-group" id="group_confirmacao">
            <button type="button" class="btn-prev" onclick="nextStep(2)">Corrigir</button>
            <button type="button" class="btn-finish" id="btn_confirmar" onclick="finalizar()">Confirmar Envio</button>
        </div>

        <div id="msg_sucesso" class="msg-sucesso-container">
            <span class="msg-sucesso-titulo">‚úÖ Solicita√ß√£o Enviada!</span>
            <span class="msg-sucesso-texto">Agora, clique abaixo para enviar o comprovante no WhatsApp.</span>
        </div>

        <button type="button" class="btn-whatsapp" id="btn_whatsapp_final" onclick="enviarWhatsapp()">
            üì≤ ENVIAR O COMPROVANTE
        </button>
    </div>
</div>

<script>
    const grupoSelecionado = localStorage.getItem('grupoSelecionado');

    const csvSources = {
        'bombeiros': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS29f9zGs72Lf557GYyR3H601ZXF94CHAejfp_mUnIbqESE7NFTvzxNQF9eyvMDROC4HZDEtWnSHRbx/pub?output=csv',
        'servicos': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8zA3MOPL8DQBSl99o72Zv0WuzkBb3SJqv0cfhxzbwA5a3ngr7rTLIJ-ZNvreQwLiV_jiE88D2VwHX/pub?output=csv',
        'seguranca': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQjXlI9WjWYK0tKWRFwblimZNv3UrvzN9osC_9gY_vZurmyjm_DSSMr9nZ6o7Tl7DN1iR3ADxfK_giy/pub?output=csv',
        'rbfacilities': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSTOfqxdOn5xHlbv-JTIWcLlSMrJk6j4RRQKXnjOK2fka4FdSB8qQjwHT8ZJuJHRbp42WfHSpQ92drh/pub?output=csv'
    };

    const whatsappNumbers = {
        'bombeiros': '5511919125032',
        'servicos': '5511940315275',
        'seguranca': '5511940315275',
        'rbfacilities': '5511940315275'
    };

    const viewFormUrls = {
        'bombeiros': 'https://docs.google.com/forms/d/e/1FAIpQLSeSr2Ff8nf9yez0sQ4-kRGLKAHoMLfGmqhTL9-1zus9_RpwvA/formResponse',
        'seguranca': 'https://docs.google.com/forms/d/e/1FAIpQLSes2uuJc13EgRLSgkrv5Ec-Vo7TMvw_SuFk9GF7iKfc5_O2sA/formResponse',
        'servicos': 'https://docs.google.com/forms/d/e/1FAIpQLSfdye7vKQ2jm1PgiqU8tWMOzdevfRCMhen66dzqpjjKz31L-Q/formResponse',
        'rbfacilities': 'https://docs.google.com/forms/d/e/1FAIpQLSfCzSdeKgbvnH5U9aEejfD2VfMFApEcR-wY1xy9S147OSylcg/formResponse'
    };

    const entryIds = {
        default: {
            re_sol: 'entry.1500160360',
            nome_sol: 'entry.1234272661',
            unidade: 'entry.1929718542',
            data_folga: 'entry.1171656144',
            re_sub: 'entry.1069916118',
            nome_sub: 'entry.972321248',
            data_pagamento: 'entry.1610514409',
            motivo: 'entry.815872191'
        }
    };
    entryIds.bombeiros = entryIds.default;
    entryIds.seguranca = entryIds.default;
    entryIds.servicos = entryIds.default;
    entryIds.rbfacilities = entryIds.default;

    const rawCsvUrl = csvSources[grupoSelecionado] || csvSources['bombeiros'];
    const CSV_URL = `${rawCsvUrl}&t=${Date.now()}`;
    const PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(CSV_URL);

    let db = {}; 

    const groupDisplayNames = {
        'bombeiros': 'Dunamis Bombeiros',
        'servicos': 'Dunamis Servi√ßos',
        'seguranca': 'Dunamis Seguran√ßa',
        'rbfacilities': 'RB Facilities'
    };

    // Carregar logo do grupo selecionado
    const logos = {
        'bombeiros': './images/logo-dunamis-bombeiros.png',
        'servicos': './images/logo-dunamis-servicos.png',
        'seguranca': './images/logo-dunamis-seguranca.png',
        'rbfacilities': './images/logo-rb.png'
    };
    if (grupoSelecionado && logos[grupoSelecionado]) {
        document.querySelector('.logo-img').src = logos[grupoSelecionado];
    }
    // Confirmacao visual do grupo
    const textoGrupoDiv = document.getElementById('grupo-selecionado-texto');
    if (grupoSelecionado && groupDisplayNames[grupoSelecionado]) {
        textoGrupoDiv.textContent = groupDisplayNames[grupoSelecionado];
    }

    window.onload = async function() {
        try {
            const response = await fetch(PROXY_URL);
            if (!response.ok) throw new Error("Erro na rede");
            const data = await response.text();
            processarCSV(data);
            document.getElementById('loading-overlay').style.display = 'none';
        } catch (error) {
            console.error("Erro:", error);
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Erro de conex√£o.");
        }
    };

    function processarCSV(texto) {
        const linhas = texto.split('\n');
        let linhaCabecalho = -1;
        // Detec√ß√£o autom√°tica de delimitador (v√≠rgula ou ponto e v√≠rgula)
        const delimitador = linhas[0].includes(';') ? ';' : ',';
        
        let idxRE = -1; let idxNome = -1; let idxStatus = -1; let idxPosto = -1; let idxTurma = -1;
        let unidadesSet = new Set();

        for(let i=0; i < Math.min(linhas.length, 30); i++) {
            let cols = linhas[i].split(delimitador).map(c => c.toUpperCase().replace(/"/g, '').trim());
            let achouRE = cols.findIndex(c => c === 'MATR√çCULA' || c === 'MATRICULA' || c === 'RE');
            let achouNome = cols.findIndex(c => c === 'COLABORADOR' || c === 'NOME' || c === 'FUNCIONARIO');
            let achouStatus = cols.findIndex(c => c.includes('SITUACAO') || c.includes('SITUA√á√ÉO') || c.includes('STATUS') || c.includes('OBS'));
            let achouPosto = cols.findIndex(c => c === 'POSTO');
            let achouTurma = cols.findIndex(c => c === 'TURMA');

            if(achouRE !== -1 && achouNome !== -1) {
                linhaCabecalho = i; idxRE = achouRE; idxNome = achouNome; idxStatus = achouStatus; idxPosto = achouPosto; idxTurma = achouTurma;
                break;
            }
        }

        if (linhaCabecalho === -1) { idxRE = 5; idxNome = 4; idxStatus = 9; linhaCabecalho = 0; }

        for (let i = linhaCabecalho + 1; i < linhas.length; i++) {
            let colunas = linhas[i].split(delimitador);
            if (colunas.length > Math.max(idxRE, idxNome)) {
                let rawRE = colunas[idxRE].replace(/"/g, '').trim();
                let nome = colunas[idxNome].replace(/"/g, '').trim();
                let status = (idxStatus !== -1 && colunas[idxStatus]) ? colunas[idxStatus].replace(/"/g, '').trim().toUpperCase() : "ATIVO";
                let turma = (idxTurma !== -1 && colunas[idxTurma]) ? colunas[idxTurma].replace(/"/g, '').trim().toUpperCase() : "";
                
                if (idxPosto !== -1 && colunas.length > idxPosto) {
                    let posto = colunas[idxPosto].replace(/"/g, '').trim();
                    if (posto) unidadesSet.add(posto);
                }

                if (rawRE.includes('-')) {
                    let partes = rawRE.split('-');
                    rawRE = partes[partes.length - 1].trim();
                }
                let reLimpo = rawRE.replace(/[^0-9]/g, '');
                if (reLimpo !== "") {
                    let chave = String(parseInt(reLimpo, 10));
                    if(nome.length > 2) db[chave] = { nome: nome, status: status, turma: turma };
                }
            }
        }

        const selectUnidade = document.getElementById('unidade_troca');
        if (unidadesSet.size > 0) {
            selectUnidade.innerHTML = '<option value="">Selecione a unidade...</option>';
            const palavrasFiltro = ["INSS", "PROCESSO", "ADMINISTRATIVO", "ADM"];

            unidadesSet.forEach(u => {
                const unidadeUpper = u.toUpperCase();
                // Filtra unidades que contenham as palavras-chave administrativas
                const deveFiltrar = palavrasFiltro.some(palavra => unidadeUpper.includes(palavra));
                if (!deveFiltrar) {
                    const opt = document.createElement('option');
                    opt.value = u; opt.textContent = u;
                    selectUnidade.appendChild(opt);
                }
            });
        }
    }

    function buscar(tipo) {
        const reInput = document.getElementById(`re_${tipo}`);
        let reDigitado = reInput.value.trim();
        if(reDigitado) {
            reDigitado = reDigitado.replace(/[^0-9]/g, ''); 
            if(reDigitado !== "") reDigitado = String(parseInt(reDigitado, 10));
        }
        const nomeField = document.getElementById(`nome_${tipo}`);
        const divErroStatus = document.getElementById(`e_status_${tipo}`);
        
        if (db[reDigitado]) { 
            const colaborador = db[reDigitado];
            if (colaborador.status.includes('AFASTADO') || colaborador.status.includes('F√âRIAS') || colaborador.status.includes('INSS') || colaborador.status.includes('DEMITIDO') || colaborador.status.includes('LICEN√áA')) {
                nomeField.value = "‚ö†Ô∏è " + colaborador.nome + " (" + colaborador.status + ")";
                nomeField.className = "status-afastado";
                if(divErroStatus) {
                    divErroStatus.innerHTML = `üö´ <strong>Bloqueado:</strong> Colaborador consta como <strong>${colaborador.status}</strong>.`;
                    divErroStatus.style.display = 'block';
                }
            } else {
                nomeField.value = colaborador.nome; 
                nomeField.className = "nome-encontrado";
                if(divErroStatus) divErroStatus.style.display = 'none';
            }
        } else { 
            nomeField.value = ""; nomeField.className = "";
            if (divErroStatus) divErroStatus.style.display = 'none';
        }
        if(tipo === 'sub' || tipo === 'sol') { if(validarMesmoRE()) validarMesmaTurma(); }
        if(tipo === 'sol') validarEscala('data_folga');
    }

    function abrirCalendario(id) { const input = document.getElementById(id); if('showPicker' in HTMLInputElement.prototype) input.showPicker(); else { input.focus(); input.click(); } }
    
    function validarMesmoRE() { 
        const r1 = document.getElementById('re_sol').value; 
        const r2 = document.getElementById('re_sub').value; 
        const err = document.getElementById('e_re'); 
        if(r1 && r2 && r1 === r2) { 
            err.style.display = 'block'; 
            err.innerHTML = '‚ùå <strong>Erro:</strong> Voc√™ colocou o seu pr√≥prio RE. Voc√™ precisa trocar com <strong>outra pessoa</strong>.'; 
            return false; 
        } 
        err.style.display = 'none'; 
    return true; 
}

function validarMesmaTurma() {
    const r1 = document.getElementById('re_sol').value;
    const r2 = document.getElementById('re_sub').value;
    const err = document.getElementById('e_re');
    
    if(!r1 || !r2 || !db[r1] || !db[r2]) return true;
    
    if(db[r1].turma && db[r2].turma && db[r1].turma === db[r2].turma) {
        err.style.display = 'block';
        err.innerHTML = '‚ùå <strong>Troca inv√°lida</strong><br>N√£o √© poss√≠vel realizar a troca com um colaborador da mesma escala.';
        return false;
    }
        return true; 
    }
    
    function getRefFolha(d) { const date = new Date(d+"T00:00:00"); let m = date.getMonth(), y = date.getFullYear(); if(date.getDate()>=22) { m++; if(m>11){m=0;y++;} } return y+"-"+m; }
    function getIntervaloFolha(d) { const date = new Date(d+"T00:00:00"); let start, end; if(date.getDate()>=22) { start=new Date(date.getFullYear(), date.getMonth(), 22); end=new Date(date.getFullYear(), date.getMonth()+1, 21); } else { start=new Date(date.getFullYear(), date.getMonth()-1, 22); end=new Date(date.getFullYear(), date.getMonth(), 21); } return `${start.toLocaleDateString('pt-BR')} at√© ${end.toLocaleDateString('pt-BR')}`; }
    
    function validarTroca() { 
        const d1 = document.getElementById('data_folga').value; 
        const d2 = document.getElementById('data_pagamento').value; 
        const errEscala = document.getElementById('e_escala');
        const errFolha = document.getElementById('e_folha');
        errEscala.style.display = "none"; errFolha.style.display = "none";
        if(!d1 || !d2) return true;
        let valido = true;
        const date1 = new Date(d1 + "T00:00:00");
        const date2 = new Date(d2 + "T00:00:00");
        const diffDays = Math.round(Math.abs(date2 - date1) / (1000 * 60 * 60 * 24)); 
        if (diffDays % 2 === 0) {
             errEscala.style.display = "block";
             errEscala.innerHTML = `‚ùå <strong>Datas na Mesma Escala:</strong> Pelas datas informadas, o posto ficaria vazio (sem cobertura).<br>Por favor, <strong>confira se voc√™ digitou as datas corretamente,</strong> pois a troca deve ocorrer entre escalas diferentes.`;
             valido = false;
        }
        if (getRefFolha(d1) !== getRefFolha(d2)) {
            const intervalo = getIntervaloFolha(d1);
            const partes = d1.split('-');
            const dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
            errFolha.style.display = "block";
            errFolha.innerHTML = `‚ö†Ô∏è <strong>Aten√ß√£o ao Per√≠odo da Folha</strong>: As duas datas precisam estar na <strong>mesma folha.</strong><br>Como voc√™ escolheu dia <strong>${dataFormatada},</strong> a data de pagamento <strong>DEVE</strong> ser entre <strong>${intervalo}.</strong>`;
            valido = false;
        }
        return valido;
    }

    function validarFolhaFechada(dateId) {
        const dateInput = document.getElementById(dateId);
        const errorDiv = document.getElementById(`e_folha_fechada_${dateId.split('_')[1]}`);
        errorDiv.style.display = 'none';

        if (!dateInput.value) return true;

        const selectedDate = new Date(dateInput.value + "T00:00:00");
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let startOfCurrentPeriod;
        if (today.getDate() >= 22) {
            startOfCurrentPeriod = new Date(today.getFullYear(), today.getMonth(), 22);
        } else {
            startOfCurrentPeriod = new Date(today.getFullYear(), today.getMonth() - 1, 22);
        }

        if (selectedDate < startOfCurrentPeriod) {
            errorDiv.innerHTML = '‚ùå <strong>Folha Encerrada:</strong> A data escolhida pertence a uma folha de pagamento j√° encerrada.';
            errorDiv.style.display = 'block';
            return false;
        }
        return true;
    }

    function validarEscala(dateId) {
        // CORRE√á√ÉO: O aviso de turma deve aparecer APENAS na etapa 1.
        if (dateId !== 'data_folga') {
            const errDiv = document.getElementById('e_turma_pagamento');
            if(errDiv) errDiv.style.display = 'none';
            return true;
        }

        const re = document.getElementById('re_sol').value;
        if(!re || !db[re] || !db[re].turma) return true;

        const turma = db[re].turma.toUpperCase();
        let worksEven = false;
        // Regra de Turma: 2 = PAR, 1 = √çMPAR (baseado no contexto atual da planilha)
        if(turma.includes('PAR') || turma === '2' || turma === '02') worksEven = true;
        else if(turma.includes('√çMPAR') || turma.includes('IMPAR') || turma === '1' || turma === '01') worksEven = false;
        else return true; // Turma sem defini√ß√£o clara de Par/Impar, ignora valida√ß√£o

        const dateInput = document.getElementById(dateId);
        if(!dateInput.value) return true;
        
        const targetDate = new Date(dateInput.value + "T00:00:00");
        const today = new Date();
        today.setHours(0,0,0,0);
        
        // Determina se HOJE √© dia de trabalho para a turma
        const todayDay = today.getDate();
        const todayIsEven = (todayDay % 2 === 0);
        let todayIsWork = worksEven ? todayIsEven : !todayIsEven;
        
        // Calcula a diferen√ßa de dias para projetar a escala 12x36
        const diffTime = targetDate - today;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        // Na 12x36, a cada dia o status inverte. Se diffDays √© par, status √© igual. Se √≠mpar, inverte.
        let targetIsWork = (diffDays % 2 === 0) ? todayIsWork : !todayIsWork;
        
        const divId = (dateId === 'data_folga') ? 'e_turma_folga' : 'e_turma_pagamento';
        const errDiv = document.getElementById(divId);
        
        if(targetIsWork) {
            errDiv.style.display = 'block';
            errDiv.innerHTML = `‚ö†Ô∏è <strong>Data inv√°lida</strong><br>N√£o √© poss√≠vel solicitar troca neste dia, pois voc√™ est√° escalado para trabalhar.`;
            return false;
        } else {
            errDiv.style.display = 'none';
            return true;
        }
    }

    function syncManual(id) { const txt = document.getElementById(id+'_txt'); let v=txt.value.replace(/\D/g,''); if(v.length>2)v=v.slice(0,2)+'/'+v.slice(2); if(v.length>5)v=v.slice(0,5)+'/'+v.slice(5); txt.value=v; if(v.length===10){ const p=v.split('/'); const iso=`${p[2]}-${p[1]}-${p[0]}`; if(!isNaN(Date.parse(iso))){ document.getElementById(id).value=iso; validarTroca(); validarFolhaFechada(id); validarEscala(id); } } }
    function syncPicker(id) { const p = document.getElementById(id).value.split('-'); if(p.length===3) { document.getElementById(id+'_txt').value=`${p[2]}/${p[1]}/${p[0]}`; validarTroca(); validarFolhaFechada(id); validarEscala(id); } }
    
    function nextStep(s) { 
        const solVal = document.getElementById('re_sol').value ? String(parseInt(document.getElementById('re_sol').value, 10)) : "";
        const subVal = document.getElementById('re_sub').value ? String(parseInt(document.getElementById('re_sub').value, 10)) : "";
        let erros = [];

        if(s===2) {
            if(!db[solVal]) erros.push("‚Ä¢ RE do solicitante n√£o encontrado.");
            else if(db[solVal].status.includes('AFASTADO') || db[solVal].status.includes('F√âRIAS') || db[solVal].status.includes('DEMITIDO')) erros.push("‚Ä¢ Solicitante AFASTADO.");
            if(!document.getElementById('unidade_troca').value) erros.push("‚Ä¢ Selecione a Unidade.");
            if(!document.getElementById('data_folga').value) erros.push("‚Ä¢ Informe a data da sua folga.");
            if(!validarFolhaFechada('data_folga')) erros.push("‚Ä¢ A data da folga pertence a uma folha encerrada.");
            if(!validarEscala('data_folga')) erros.push("‚Ä¢ Data da folga inv√°lida para sua turma (Par/√çmpar).");
        }
        
        if(s===3) {
            if(!db[subVal]) erros.push("‚Ä¢ RE do substituto n√£o encontrado.");
            else if(db[subVal].status.includes('AFASTADO') || db[subVal].status.includes('F√âRIAS') || db[subVal].status.includes('DEMITIDO')) erros.push("‚Ä¢ Substituto AFASTADO.");
            if(!validarMesmoRE()) erros.push("‚Ä¢ Voc√™ n√£o pode trocar com voc√™ mesmo (RE duplicado).");
            else if(!validarMesmaTurma()) erros.push("‚Ä¢ Troca inv√°lida: Colaboradores da mesma turma.");
            if(!validarFolhaFechada('data_pagamento')) erros.push("‚Ä¢ A data de pagamento pertence a uma folha encerrada.");
            if(!validarEscala('data_pagamento')) erros.push("‚Ä¢ Data de pagamento inv√°lida para sua turma (Par/√çmpar).");
            if(!validarTroca()) erros.push("‚Ä¢ Problemas com as datas (mesma escala ou folha diferente).");
            if(document.getElementById('motivo_troca').value.trim().length < 5) erros.push("‚Ä¢ Informe o motivo da troca.");
        }

        if(erros.length > 0) {
            alert("N√£o √© poss√≠vel avan√ßar. Verifique os seguintes erros:\n\n" + erros.join("\n"));
            return;
        }
        
        document.querySelectorAll('.step').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.progress-bar span').forEach(e=>e.classList.remove('active'));
        document.getElementById('step'+s).classList.add('active'); 
        document.getElementById('p'+s).classList.add('active');
        
        if(s===3) {
            document.getElementById('resumo_txt').innerHTML = `
                üìå <b>Solicitante:</b> ${document.getElementById('nome_sol').value}<br>
                üè¢ <b>Unidade:</b> ${document.getElementById('unidade_troca').value}<br>
                ü§ù <b>Substituto:</b> ${document.getElementById('nome_sub').value}<br>
                üóìÔ∏è <b>Folga:</b> ${document.getElementById('data_folga').value.split('-').reverse().join('/')}<br>
                üîÅ <b>Pagamento:</b> ${document.getElementById('data_pagamento').value.split('-').reverse().join('/')}<br>
                üí¨ <b>Motivo:</b> ${document.getElementById('motivo_troca').value}
            `;
        }
    }
    
    function finalizar() {
        const btn = document.getElementById('btn_confirmar');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const entryMap = entryIds[grupoSelecionado] || entryIds.bombeiros;
        const baseUrl = viewFormUrls[grupoSelecionado] || viewFormUrls.bombeiros;

        const params = new URLSearchParams();
        params.append(entryMap.re_sol, document.getElementById('re_sol').value);
        params.append(entryMap.nome_sol, document.getElementById('nome_sol').value);
        params.append(entryMap.unidade, document.getElementById('unidade_troca').value);
        params.append(entryMap.data_folga, document.getElementById('data_folga').value);
        params.append(entryMap.re_sub, document.getElementById('re_sub').value);
        params.append(entryMap.nome_sub, document.getElementById('nome_sub').value);
        params.append(entryMap.data_pagamento, document.getElementById('data_pagamento').value);
        params.append(entryMap.motivo, document.getElementById('motivo_troca').value);

        const finalUrl = `${baseUrl}?${params.toString()}&submit=Submit`;

        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.name = 'hidden-iframe-for-submission';
        document.body.appendChild(iframe);
        iframe.src = finalUrl;

        // Assume submission is successful after a delay and update UI
        setTimeout(() => {
            document.getElementById('group_confirmacao').style.display = 'none';
            document.getElementById('msg_sucesso').style.display = 'block';
            document.getElementById('btn_whatsapp_final').style.display = 'flex';
            // Clean up the iframe
            if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
        }, 1500);
    }
    
    function enviarWhatsapp() {
        const targetPhone = whatsappNumbers[grupoSelecionado] || whatsappNumbers['bombeiros'];
        const txt = `*COMPROVANTE - SOLICITA√á√ÉO DE TROCA*\n\n` +
                    `üë§ *Solicitante:* ${document.getElementById('nome_sol').value} (RE: ${document.getElementById('re_sol').value})\n` +
                    `üóìÔ∏è *Data da Folga:* ${document.getElementById('data_folga_txt').value}\n` +
                    `üè¢ *Unidade:* ${document.getElementById('unidade_troca').value}\n\n` +
                    `ü§ù *Substituto:* ${document.getElementById('nome_sub').value} (RE: ${document.getElementById('re_sub').value})\n` +
                    `üîÅ *Data Pagamento:* ${document.getElementById('data_pagamento_txt').value}\n\n` +
                    `üí¨ *Motivo:* ${document.getElementById('motivo_troca').value}`;
        window.open(`https://api.whatsapp.com/send?phone=${targetPhone}&text=${encodeURIComponent(txt)}`, '_blank');
    }
</script>
</body>
</html>